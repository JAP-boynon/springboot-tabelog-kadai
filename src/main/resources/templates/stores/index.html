<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
     <div th:replace="~{fragment :: meta}"></div>
    <div th:replace="~{fragment :: styles}"></div>
    <title>店舗一覧</title>
</head>

<body>

   <div th:replace="~{fragment :: header}"></div>

<main class="container pt-4 pb-5">

  <div class="row">

    <!-- 🔹 左：検索サイドバー -->
    <div class="col-md-3">

      <!-- 検索フォーム（今あるやつをここへ） -->
      <form method="get" th:action="@{/stores}" class="mb-4">

        <div class="mb-3">
          <input type="text"
                 name="keyword"
                 class="form-control"
                 placeholder="店名・カテゴリ"
                 th:value="${keyword}">
        </div>

        <div class="mb-3">
          <select name="category" class="form-select">
            <option value="">カテゴリから探す</option>
             <option value="居酒屋" th:selected="${category == '居酒屋'}">居酒屋</option>
            <option value="焼肉" th:selected="${category == '焼肉'}">焼肉</option>
            <option value="寿司" th:selected="${category == '寿司'}">寿司</option>
            <option value="定食" th:selected="${category == '定食'}">定食</option>
            <option value="ラーメン" th:selected="${category == 'ラーメン'}">ラーメン</option>
            <option value="カレー" th:selected="${category == 'カレー'}">カレー</option>
            <option value="中華料理" th:selected="${category == '中華料理'}">中華料理</option>
            <option value="イタリア料理" th:selected="${category == 'イタリア料理'}">イタリア料理</option>
            <option value="スイーツ" th:selected="${category == 'スイーツ'}">スイーツ</option>
          </select>
        </div>

        <div class="mb-3">
          <select name="price" class="form-select">
            <option value="">予算から探す</option>
            <option value="500">〜500円</option>
            <option value="1000">〜1000円</option>
            <option value="1500">〜1500円</option>
            <option value="2000">〜2000円</option>
            <option value="3000">〜3000円</option>
            <option value="5000">〜5000円</option>
            <option value="10000">〜10000円</option>
          </select>
        </div>

        <button type="submit" class="btn btn-danger w-100">
          検索
        </button>

      </form>
    </div>

    <!-- 🔹 右：店舗一覧 -->
    <div class="col-md-9">

      <!-- 検索結果件数 
      <p class="fs-5 mb-3"
         th:text="${'検索結果：' + storePage.totalElements + '件'}"></p>
         -->
         
         
         <div class="d-flex justify-content-between align-items-center mb-3">

  <p class="fs-5 mb-0"
     th:text="${'検索結果：' + storePage.totalElements + '件'}"></p>
     
 <!-- 並び替え -->
  <form method="get" th:action="@{/stores}">
  
  <!-- 🔽 既存の検索条件を保持する（重要） -->
  <input type="hidden" name="keyword" th:value="${keyword}">
  <input type="hidden" name="category" th:value="${category}">
  <input type="hidden" name="price" th:value="${price}">

  <!-- 🔽 並び替え -->
 <select name="sort"
        class="form-select"
        onchange="this.form.submit()">

  <option value="new_desc"
          th:selected="${sort == null || sort == '' || sort == 'new_desc'}">
    新着順
  </option>
  

  <option value="rating_desc"
          th:selected="${sort == 'rating_desc'}">
    評価が高い順
  </option>

<option value="price_desc"
        th:selcted="${sort == 'price_desc'}">
        価格が高い順
        </option>

  <option value="price_asc"
          th:selected="${sort == 'price_asc'}">
    価格が安い順
  </option>

  <option value="review_desc"
          th:selected="${sort == 'review_desc'}">
    口コミが多い順
  </option>

</select>

</form>
</div>

      <!-- 店舗カード -->
     <div th:each="store : ${storePage.content}" class="mb-3">

        <a th:href="@{/stores/{id}(id=${store.id})}"
          class="store-card-link">
           <div class="store-card list-store-card">

         
            <div class="row g-0">

              <!-- 画像 -->
             <div class="col-md-4 store-image">
             <img
              th:src="@{/storage/{file}(file=${store.imageName})}"
               alt="店舗画像">
               </div>

              <!-- 情報 -->
              <div class="col-md-8">
                <div class="card-body">

                  <h5 th:text="${store.name}"></h5>

               <div class="store-rating">
  <div class="stars"
       th:with="
         rating=${store.averageRating ?: 0},
         full=${T(java.lang.Math).floor(rating)},
         half=${rating - full >= 0.5}
       ">

    <span th:each="i : ${#numbers.sequence(1,5)}">
      <span th:if="${i <= full}" class="star-full">★</span>
      <span th:if="${i == full + 1 and half}" class="star-half">★</span>
      <span th:if="${i > full + (half ? 1 : 0)}" class="star-empty">★</span>
    </span>
  </div>

  <span class="rating-score"
        th:text="${#numbers.formatDecimal(store.averageRating ?: 0, 1, 1)}">
  </span>
</div>

                <span class="category-tag"
                 th:text="${store.categoryName}"></span>
            

                  <p class="mt-2 text-muted"
                     th:text="${store.description}"></p>

                <p class="fw-bold" th:text="${store.price} + '円〜'"></p>

                </div>
              </div>

            </div>
          </div>

        </a>
      </div>

      <!-- 🔹 ページネーション -->
      <div th:if="${storePage.totalPages > 1}"
           class="d-flex justify-content-center mt-4">

        <ul class="pagination">

           <!-- 前へ -->
      <li class="page-item">
        <span th:if="${storePage.first}"
              class="page-link disabled">前</span>

        <a th:unless="${storePage.first}"
           th:href="@{/stores(
             page=${storePage.number - 1},
             keyword=${keyword},
             category=${category},
             price=${price},
             sort=${sort}
           )}"
           class="page-link">
           前
        </a>
      </li>

      <!-- ページ番号 -->
      <li th:each="i : ${#numbers.sequence(0, storePage.totalPages - 1)}"
          class="page-item">

        <span th:if="${i == storePage.number}"
              class="page-link active"
              th:text="${i + 1}">
        </span>

        <a th:unless="${i == storePage.number}"
           th:href="@{/stores(
             page=${i},
             keyword=${keyword},
             category=${category},
             price=${price},
             sort=${sort}
           )}"
           class="page-link"
           th:text="${i + 1}">
        </a>
      </li>

      <!-- 次へ -->
      <li class="page-item">
        <span th:if="${storePage.last}"
              class="page-link disabled">次</span>

        <a th:unless="${storePage.last}"
           th:href="@{/stores(
             page=${storePage.number + 1},
             keyword=${keyword},
             category=${category},
             price=${price},
             sort=${sort}
           )}"
           class="page-link">
           次
        </a>
      </li>

    </ul>
</div>
</main>

<div th:replace="~{fragment :: footer}"></div>
<div th:replace="~{fragment :: scripts}"></div>

</body>
</html>