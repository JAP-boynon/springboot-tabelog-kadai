<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
       <div th:replace="~{fragment :: meta}"></div>
    <div th:replace="~{fragment :: styles}"></div>
    <!-- Flatpickr -->
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <title th:text="${store.name}">店舗詳細</title>
</head>

<body>


   <div th:replace="~{fragment :: header}"></div>


<main class="container pt-4 pb-5">
	<nav aria-label="breadcrumb" class="mb-3">
  <ol class="breadcrumb">

    <li class="breadcrumb-item">
      <a th:href="@{/}">ホーム</a>
    </li>

    <li class="breadcrumb-item">
      <a th:href="@{/stores}">店舗一覧</a>
    </li>

    <li class="breadcrumb-item">
      <a th:href="@{/stores/{id}(id=${store.id})}"
         th:text="${store.name}">
      </a>
    </li>

    <li class="breadcrumb-item active"
        aria-current="page">
      レビュー
    </li>

  </ol>
</nav>

	<!--
	<p>【デバッグ】imageName = <span th:text="${store.imageName}"></span></p>
	-->
	   
    <!-- 店舗画像 -->
<div class="store-detail-image mb-4">
  <img
    th:src="@{/storage/{file}(file=${store.imageName})}"
    alt="店舗画像"
    style="width:100%; max-width:700px; object-fit:cover;"
  >
</div>

　　　　<h1 class="page-title mb-4" th:text="${store.name}"></h1>

  <div class="store-rating">
  <div class="stars"
       th:with="
         rating=${store.averageRating ?: 0},
         full=${T(java.lang.Math).floor(rating)},
         half=${rating - full >= 0.5}
       ">

    <span th:each="i : ${#numbers.sequence(1,5)}">
      <span th:if="${i <= full}" class="star-full">★</span>
      <span th:if="${i == full + 1 and half}" class="star-half">★</span>
      <span th:if="${i > full + (half ? 1 : 0)}" class="star-empty">★</span>
    </span>
  </div>

  <span class="rating-score"
        th:text="${#numbers.formatDecimal(store.averageRating ?: 0, 1, 1)}">
  </span>
</div>

		<p>
		<strong>カテゴリ：</strong>
		<span th:text="${store.categoryName}">ラーメン</span>
		</p>
		
		<p>
			<strong>価格：</strong>
			<span th:if="${store.price != null}"
			      th:text="${#numbers.formatInteger(store.price, 1, 'COMMA')} + '円'">
			      </span>
			      <span th:unless="${store.price != null}">未設定</span>
		</p>
		
		<p>
			<strong>説明：</strong>
			<span class="pre-wrap"
			      th:text="${store.description}">店舗説明</span>
		</p>
		<p>
			<strong>営業時間：</strong>
			<span th:text="${store.businessHours}">11:00~22:00</span>
		</p>
		
		<p>
			<strong>定休日：</strong>
			<span th:text="${store.regularHoliday}">水曜日</span>
		</p>
		
		<p>
            <strong>郵便番号：</strong>
            <span th:text="${store.postalCode}">000-0000</span>
        </p>
		
		<p>
			<strong>住所：</strong>
			<span th:text="${store.address}">名古屋◯◯区</span>
		</p>
		
		<p>
			<strong>電話番号：</strong>
			<span th:text="${store.phoneNumber}">052-000-0000</span>
		</p>
		
		<hr>
		
		<div sec:authorize="isAnonymous()" class="mt-4">
    <div class="card">
        <div class="card-body text-center">
            <p class="card-text">
                予約するには
                <a th:href="@{/login}">ログイン</a>
                が必要です。
            </p>
            <button class="btn btn-danger w-100" disabled>
                予約する
            </button>
        </div>
    </div>
</div>

<div sec:authorize="hasRole('ROLE_GENERAL')">

		<h3 class="mt-5 mb-3">予約する</h3>

<form th:action="@{/stores/{id}/reservations(id=${store.id})}"
      th:object="${reservationInputForm}"
      method="post">

    <!-- 予約日 -->
    <div class="mb-3">
        <label class="form-label">予約日</label>
        <input type="text"
               id="reservationDate"
               th:field="*{reservationDate}"
               class="form-control"
               placeholder="日付を選択">
        <div class="text-danger"
             th:errors="*{reservationDate}"></div>
    </div>

    <!-- 予約時間 -->
    <div class="mb-3">
        <label class="form-label">予約時間</label>
        <select th:field="*{reservationTime}" class="form-select">
            <option value="">時間を選択</option>
            <option th:each="time : ${reservationTimes}"
                    th:value="${time}"
                    th:text="${time}">
            </option>
        </select>
        <div class="text-danger"
             th:errors="*{reservationTime}"></div>
    </div>

    <!-- 人数 -->
    <div class="mb-4">
        <label class="form-label">人数</label>
        <input type="number"
               th:field="*{numberOfPeople}"
               class="form-control"
               min="1"
               max="30">
        <div class="text-danger"
             th:errors="*{numberOfPeople}"></div>
    </div>

    <button type="submit" class="btn btn-danger">
        予約する
    </button>
</form>

<h2 class="mt-5">レビュー</h2>

<div class="reviews">

  <div th:each="review : ${reviews}" class="review-card mb-3">

    <!-- ★表示（レビュー単体） -->
    <div class="review-rating">
      <span th:each="i : ${#numbers.sequence(1,5)}">
        <span th:text="${i <= review.rating ? '★' : '☆'}"></span>
      </span>
    </div>

    <!-- コメント -->
    <p th:text="${review.comment}">コメント</p>

    <!-- 投稿者 -->
    <small class="text-muted"
           th:text="${review.user.name}">ユーザー名</small>
        <!-- 投稿日 -->
           <small class="text-muted"
       th:text="${#temporals.format(review.createdAt, 'yyyy/MM/dd')}">
</small>

    <!-- 👇 削除ボタン（自分のレビューだけ） -->
    <form th:if="${review.user.email == #authentication.name}"
          th:action="@{/reviews/delete/{id}(id=${review.id})}"
          method="post"
          class="mt-2">
      <button type="submit"
              class="btn btn-sm btn-danger"
              onclick="return confirm('本当に削除しますか？')">
        削除
      </button>
    </form>

  </div>

</div>
<hr>

<h3 class="mt-4">レビューを書く</h3>

<form th:action="@{/reviews/create}"
      method="post"
      sec:authorize="isAuthenticated()">

  <input type="hidden" name="storeId"
         th:value="${store.id}">

  <!-- ★評価 -->
  <div class="mb-2">
    <label>評価：</label>
    <select name="rating" class="form-select w-auto">
      <option th:each="i : ${#numbers.sequence(1,5)}"
              th:value="${i}"
              th:text="${i}">
      </option>
    </select>
  </div>

  <!-- コメント -->
  <div class="mb-3">
    <textarea name="comment"
              class="form-control"
              rows="3"
              placeholder="コメントを書く"></textarea>
  </div>

  <button type="submit"
          class="btn btn-primary">
    投稿
  </button>
  
</form>

<!-- 未ログイン -->
<p sec:authorize="!isAuthenticated()">
  <a th:href="@{/login}">ログイン</a>するとレビューできます
</p>
		
	<div class="mt-4">
  <a th:href="@{/stores}" class="btn btn-outline-secondary btn-sm">
    ← 一覧に戻る
  </a>
  <a th:href="@{/}" class="btn btn-outline-primary btn-sm ms-2">
    トップへ
  </a>
</div>

</main>
<div th:replace="~{fragment :: footer}"></div>
<div th:replace="~{fragment :: scripts}"></div>

<!-- Flatpickr -->
        <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
        <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ja.js"></script>
        <script th:src="@{/js/flatpickr-reservation.js}"></script>  
</body>
</html>